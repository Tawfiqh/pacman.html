<!-- Pacman Game TODO list
- ‚úÖ Test in browser    
- ‚úÖ Initialise Game State
- ‚úÖ Setup Keyboard Controls
- ‚úÖ Setup Run Loop to update game state and render game
- ‚úÖ Move enemies + player
- ‚úÖ Handle Collisions
- ‚úÖ Add speed to enemies
- ‚úÖ Stop creatures going off of the map!
- ‚úÖ Give enemies random colours
- ‚úÖ Update Score
- Resize to window size -- zoom/scale (and centre the play window on the screen)
- Animate pacman
- Display score
- Show score on end-screen
- Add cherries!! If the player eats a cherry then he can eat the ghosts! 
- Add walls - that the player can't move through etc
- Add more enemies as times goes on!

- Restart button on end-screen
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacman üëª</title>
    <style>
        body {
            background-color: #000;
        }

        .canvas-container {
            position: relative;
            text-align: center;
            padding-top: 44px;
        }

        canvas {
            border: 1px solid greenyellow;
            border-radius: 10px;
            width: min(80vw, 80vh);
            height: min(80vw, 80vh);
        }

        #gameOver {
            display: none;
            width: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid greenyellow;

            border-radius: 10px;

            padding: 20px;
            z-index: 10;
            text-align: center;
            font-family: 'Courier New', Courier, monospace;

            background-color: greenyellow;
            color: black;

        }
    </style>
</head>

<body>

    <div class="canvas-container">
        <canvas id="gameBoard"></canvas>
        <div id="gameOver">
            <h1> Score: <span id="finalScore">0</span> </h1>
            <h1> Game Over - refresh to play again </h1>

        </div>
    </div>
</body>

<script>

    // .___  ___.      ___       __  .__   __.      _______      ___      .___  ___.  _______ 
    // |   \/   |     /   \     |  | |  \ |  |     /  _____|    /   \     |   \/   | |   ____|
    // |  \  /  |    /  ^  \    |  | |   \|  |    |  |  __     /  ^  \    |  \  /  | |  |__   
    // |  |\/|  |   /  /_\  \   |  | |  . `  |    |  | |_ |   /  /_\  \   |  |\/|  | |   __|  
    // |  |  |  |  /  _____  \  |  | |  |\   |    |  |__| |  /  _____  \  |  |  |  | |  |____ 
    // |__|  |__| /__/     \__\ |__| |__| \__|     \______| /__/     \__\ |__|  |__| |_______|
    class PacmanGame {

        constructor(config) { // default map size is 100 units
            console.log('Welcome to Pacman üëª');

            // 1.
            this.setupGameState(config.mapSize);

            // 2 - Setup the game map - with the map size
            this.renderer = new Renderer(this.gameState.mapSize)

            // 3.
            this.setupKeyboardControls();

            // 4
            this.setupGameRunLoop(config.runLoopInterval);

        }

        setupGameState(mapSize) {
            this.gameState = {
                mapSize: mapSize, // Currently we just support a square map
                enemies: [
                    new Ghost(mapSize / 2, 0, DIRECTIONS.RIGHT, "pink", mapSize),
                    new Ghost(mapSize / 2, mapSize, DIRECTIONS.LEFT, "blue", mapSize),
                    new Ghost(mapSize, mapSize / 2, DIRECTIONS.UP, "green", mapSize),
                    new Ghost(0, mapSize / 2, DIRECTIONS.DOWN, "red", mapSize)
                ],
                player: new Creature(mapSize / 2, mapSize / 2, DIRECTIONS.RIGHT, mapSize),
                score: 0
            };
        }


        movePlayerInDirection(direction) {
            this.gameState.player.direction = direction;
            console.log('MovePlayerInDirection', direction);
        }

        setupKeyboardControls() {

            document.addEventListener('keydown', (event) => {
                console.log('keydown', event.key);
                switch (event.key) {
                    case 'ArrowUp', 'w':
                        this.movePlayerInDirection(DIRECTIONS.UP);
                        break;
                    case 'ArrowDown', 's':
                        this.movePlayerInDirection(DIRECTIONS.DOWN);
                        break;
                    case 'ArrowLeft', 'a':
                        this.movePlayerInDirection(DIRECTIONS.LEFT);
                        break;
                    case 'ArrowRight', 'd':
                        this.movePlayerInDirection(DIRECTIONS.RIGHT);
                        break;
                }
            });

        }

        runLoop; // this holds the interval id for the run loop so that we can cancel it later when game ends
        setupGameRunLoop(runLoopInterval) {
            this.runLoop = setInterval(() => { //RunLoop Code
                console.log('RunLoop');
                this.updateGameState();
                this.renderGame();
            }, runLoopInterval);
        }

        updateGameState() {
            // Move player
            this.gameState.player.move()
            this.gameState.score += 1;

            // Move enemies
            for (let enemy of this.gameState.enemies) {
                enemy.move()
                let gameHasEnded = enemy.checkCollisionWithPlayer(this.gameState.player)
                if (gameHasEnded) { this.endGame() }
            }

        }

        renderGame() {
            this.renderer.renderGame(this.gameState);
        }

        endGame() {
            clearInterval(this.runLoop)
            this.renderer.gameOver(this.gameState.score)

        }
    }

    //  __    __   _______  __      .______    _______ .______          _______.
    // |  |  |  | |   ____||  |     |   _  \  |   ____||   _  \        /       |
    // |  |__|  | |  |__   |  |     |  |_)  | |  |__   |  |_)  |      |   (----`
    // |   __   | |   __|  |  |     |   ___/  |   __|  |      /        \   \    
    // |  |  |  | |  |____ |  `----.|  |      |  |____ |  |\  \----.----)   |   
    // |__|  |__| |_______||_______|| _|      |_______|| _| `._____|_______/    
    // Immutable Directions Enum
    const DIRECTIONS = Object.freeze({
        UP: '‚¨ÜÔ∏è',
        DOWN: '‚¨áÔ∏è',
        LEFT: '‚¨ÖÔ∏è',
        RIGHT: '‚û°Ô∏è'
    });

    function randomDirection() {
        const directionsArray = Object.values(DIRECTIONS);
        return directionsArray[Math.floor(Math.random() * directionsArray.length)];
    }


    //      _______..______   .______       __  .___________. _______     _______.
    //     /       ||   _  \  |   _  \     |  | |           ||   ____|   /       |
    //    |   (----`|  |_)  | |  |_)  |    |  | `---|  |----`|  |__     |   (----`
    //     \   \    |   ___/  |      /     |  |     |  |     |   __|     \   \    
    // .----)   |   |  |      |  |\  \----.|  |     |  |     |  |____.----)   |   
    // |_______/    | _|      | _| `._____||__|     |__|     |_______|_______/    
    class Creature {

        constructor(x, y, direction, mapSize, size = 5, speed = gameplayConstants.initialSpeed) {
            this.x = x;
            this.y = y;
            this.direction = direction;
            this.speed = speed
            this.mapSize = mapSize;
            this.size = size;
        }

        move() {
            switch (this.direction) {
                case DIRECTIONS.UP:
                    this.y -= this.speed;
                    break;
                case DIRECTIONS.DOWN:
                    this.y += this.speed;
                    break;
                case DIRECTIONS.LEFT:
                    this.x -= this.speed;
                    break;
                case DIRECTIONS.RIGHT:
                    this.x += this.speed;
                    break;
            }
            this.loopAroundIfNeeded();
        }

        loopAroundIfNeeded() {
            if (this.x < 0) { // too far left
                this.x = this.mapSize
            }
            if (this.y < 0) { // too far up
                this.y = this.mapSize
            }
            if (this.x > this.mapSize) { // too far right
                this.x = 0
            }
            if (this.y > this.mapSize) { // too far down
                this.y = 0
            }
        }
    }


    class Ghost extends Creature {
        currentMoves = 0;
        MAX_MOVES = gameplayConstants.enemyMaxMovesInSameDirection;


        constructor(x, y, direction, color, speed = gameplayConstants.enemySpeed) {
            super(x, y, direction, speed);
            this.color = color;
        }

        move() {
            super.move();
            this.currentMoves++;

            if (this.currentMoves >= this.MAX_MOVES) {
                this.turnAroundRandomlyAndGetFaster();
            }
        }

        turnAroundRandomlyAndGetFaster() {
            this.changeDirectionRandomly()
            this.speed += gameplayConstants.enemyIncreaseSpeed
        }

        changeDirectionRandomly() {
            this.direction = randomDirection();
            this.currentMoves = 0;
        }

        checkCollisionWithPlayer(player) {
            let dx = Math.abs(player.x - this.x);
            let dy = Math.abs(player.y - this.y);
            let distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < player.size + this.size) {
                return true
            }

            return false
        }

    }

    // .______       _______ .__   __.  _______   _______ .______       _______ .______      
    // |   _  \     |   ____||  \ |  | |       \ |   ____||   _  \     |   ____||   _  \     
    // |  |_)  |    |  |__   |   \|  | |  .--.  ||  |__   |  |_)  |    |  |__   |  |_)  |    
    // |      /     |   __|  |  . `  | |  |  |  ||   __|  |      /     |   __|  |      /     
    // |  |\  \----.|  |____ |  |\   | |  '--'  ||  |____ |  |\  \----.|  |____ |  |\  \----.
    // | _| `._____||_______||__| \__| |_______/ |_______|| _| `._____||_______|| _| `._____|
    class Renderer {

        scaleFactor = 10; // this is the number of pixels per game unit

        constructor(initialSize) {
            this.canvas = document.getElementById("gameBoard");
            this.ctx = this.canvas.getContext("2d");

            // set width and height to gameState width and height
            this.canvas.width = initialSize * this.scaleFactor;
            this.canvas.height = initialSize * this.scaleFactor;
        }

        renderCharacter(character, color) {

            const ctx = this.ctx

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.arc(
                character.x * this.scaleFactor,
                character.y * this.scaleFactor,
                character.size * this.scaleFactor,
                0, 2 * Math.PI
            );
            ctx.stroke();
            ctx.fill();
        }


        clearCanvas() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }

        renderGame(gameState) {
            this.clearCanvas();

            // Render Player
            this.renderCharacter(gameState.player, "yellow")

            // Render enemies
            for (let enemy of gameState.enemies) {
                this.renderCharacter(enemy, enemy.color)
            }

            // Render score
            this.renderScore(gameState.score);
        }

        renderScore(score) {
            this.ctx.font = "24px 'Courier New', Courier, monospace";
            this.ctx.fillStyle = "greenyellow";
            this.ctx.fillText("Score: " + score, 10, 30);
        }

        gameOver(finalScore) {
            console.log("----GAME OVER = refresh to play again ----")
            document.getElementById("gameOver").style.display = "block";
            document.getElementById("finalScore").innerHTML = finalScore;

        }
    }

    //  __  .__   __.  __  .___________. __       ___       __       __       _______. _______ 
    // |  | |  \ |  | |  | |           ||  |     /   \     |  |     |  |     /       ||   ____|
    // |  | |   \|  | |  | `---|  |----`|  |    /  ^  \    |  |     |  |    |   (----`|  |__   
    // |  | |  . `  | |  |     |  |     |  |   /  /_\  \   |  |     |  |     \   \    |   __|  
    // |  | |  |\   | |  |     |  |     |  |  /  _____  \  |  `----.|  | .----)   |   |  |____ 
    // |__| |__| \__| |__|     |__|     |__| /__/     \__\ |_______||__| |_______/    |_______|
    const gameplayConstants = {
        initialSpeed: 1,
        enemySpeed: 1.1,
        enemyIncreaseSpeed: 0.05,
        enemyMaxMovesInSameDirection: 15,
    }

    const config = {
        mapSize: 100,
        runLoopInterval: 24
    }

    new PacmanGame(config)

</script>